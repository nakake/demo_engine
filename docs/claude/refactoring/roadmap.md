# リファクタリング ロードマップ

## 概要

Demo Engine の段階的改善計画。現在のプロトタイプから本格的な 3D エンジンへの進化を3段階で実現します。

```
Current State → Phase 1 → Phase 2 → Phase 3
プロトタイプ   クリーンアップ  アーキテクチャ改善   本格3Dエンジン
```

## フェーズ一覧

| フェーズ | 期間 | リスク | 目標 | 成果物 |
|---------|------|-------|------|--------|
| **Phase 1** | 1-2日 | 🟢 低 | 技術的負債解消 | クリーンなコードベース |
| **Phase 2** | 1-2週間 | 🟡 中 | アーキテクチャ改善 | 拡張可能な設計 |
| **Phase 3** | 1-3ヶ月 | 🔴 高 | 本格3Dエンジン | プロダクションレディ |

## 詳細スケジュール

### Phase 1: 即座のリファクタリング (1-2日)

**目標**: 開発基盤の整備とコード品質向上

**Week 1**
- **Day 1**
  - [ ] 未使用import・変数の削除 (2時間)
  - [ ] Debug出力の制御システム実装 (3時間)
  - [ ] constants.rs作成とマジックナンバー移行 (2時間)
- **Day 2**  
  - [ ] 未使用エラー型の整理 (1時間)
  - [ ] 基本ドキュメント追加 (2時間)
  - [ ] テストディレクトリ構造作成 (2時間)
  - [ ] 基本メトリクス実装 (2時間)

**成功基準**: 
- ✅ cargo build で警告ゼロ
- ✅ 構造化されたログ出力
- ✅ テスト実行環境の整備

### Phase 2: 基盤整備完成 (分割実施)

**Phase 2.1 完了 (2025-08-12)**: GraphicsEngine分割
- ✅ **GraphicsEngine 分割**: Renderer + SurfaceManager + GraphicsEngine（統制層）
- ✅ **Renderer実装**: 純粋レンダリングロジック、CommandBuffer返却
- ✅ **SurfaceManager実装**: Surface管理・フレーム取得・表示
- ✅ **後方互換性維持**: 既存API（new/render/resize）シグネチャ不変

**Phase 2.2 残り項目 (3-5日)**:
- **constants.rs作成**: マジックナンバー解消
- **ログシステム構築**: println! → log::debug! 置換  
- **基本メトリクス実装**: FPS/フレーム時間監視

**成功基準**:
- ✅ 責任分離されたアーキテクチャ（完了）
- 🔲 統合設定システム（constants.rs）
- 🔲 構造化ログシステム
- 🔲 パフォーマンス監視基盤

### Phase 3: エンジン機能拡張 (2-3週間)

**目標**: 本格的なエンジン仕様の策定と実装

**Week 1: エンジン基盤設計**
- **Scene管理システム**: SceneManager設計、複数シーン、遷移システム
- **入力システム設計**: InputBinding、InputAction、カスタマイズ可能な入力
- **リソース管理拡張**: 動的ロード、メモリ管理最適化

**Week 2-3: 実装と最適化**
- **エンジン機能実装**: Scene遷移、入力カスタマイズ
- **パフォーマンス最適化**: GPU最適化、並列処理
- **テストと統合**: 包括的テスト、ドキュメント整備

**成功基準**:
- 🔲 SceneManager（複数シーン + 遷移）
- 🔲 カスタマイズ可能な入力システム
- 🔲 拡張されたリソース管理
- 🔲 パフォーマンス最適化基盤

## 優先度マトリクス

### 高優先度 (必須)
1. ~~**Phase 1 全体**~~ ✅ - 技術的負債の解消（完了）
2. ~~**GraphicsEngine 分割**~~ ✅ - アーキテクチャの基盤（完了）
3. **Phase 2.2 基盤整備** - constants.rs、ログ、メトリクス
4. **Scene管理システム** - エンジンとしての基本機能

### 中優先度 (推奨)  
1. **入力システム設計** - カスタマイズ可能な入力
2. **リソース管理拡張** - 動的ロード機能
3. **パフォーマンス最適化** - GPU最適化基盤
4. **テスト・ドキュメント強化** - 品質保証

### 低優先度 (Phase 4以降)
1. **ECS導入** - 大規模システム向け
2. **PBRレンダリング** - 高品質描画
3. **物理シミュレーション** - 特定用途向け
4. **エディターツール** - コンテンツ制作向け

## リスク評価と対策

### Phase 1 リスク (🟢 低)
- **リスク**: 既存機能の破壊
- **対策**: 小さい変更、段階的実装、テスト併用

### Phase 2 リスク (🟡 中)
- **リスク**: アーキテクチャ変更による不安定化
- **対策**: ブランチ分離、統合テスト、ロールバック計画

### Phase 3 リスク (🔴 高)
- **リスク**: 大規模変更による開発期間延長
- **対策**: MVP方式、段階的リリース、機能の優先度付け

## 成功メトリクス

### 技術メトリクス
- **コード品質**: 警告数、テストカバレッジ、Clippy 評価
- **パフォーマンス**: FPS、メモリ使用量、レンダリング時間
- **保守性**: 循環的複雑度、モジュール結合度

### 機能メトリクス  
- **Phase 1**: 警告0個、テスト実行可能、ドキュメント整備
- **Phase 2**: 複数シーン、設定外部化、マルチオブジェクト
- **Phase 3**: PBR対応、エディターUI、物理シミュレーション

## 依存関係グラフ

```
Phase 1 (基盤整備)
    ↓
Phase 2-1 (アーキテクチャ)
    ├── Phase 2-2 (設定システム)
    └── Phase 2-3 (機能拡張)
        ↓
Phase 3-1 (ECS)
    ├── Phase 3-2 (レンダリング拡張)
    └── Phase 3-3 (ツール・最適化)
```

## 中断・復帰戦略

各フェーズは独立して価値を提供するよう設計されています：

- **Phase 1のみ完了**: クリーンで保守しやすいプロトタイプ
- **Phase 2まで完了**: 小規模な3Dアプリケーション開発可能
- **Phase 3まで完了**: 商用レベルの3Dエンジン

## 次のステップ

1. **Phase 1 開始**: [phase_1_immediate.md](./phase_1_immediate.md) の実装チェックリストに従う
2. **進捗追跡**: 各フェーズの成功基準を満たしているかチェック
3. **定期レビュー**: 週次でロードマップの見直しと調整

---

**現在の状態**: Phase 2.1 完了 (GraphicsEngine分割, 2025-08-12)  
**次のアクション**: Phase 2.2 基盤整備  
**推定完了時期**: Phase 2 (3-5日後), Phase 3 (2-3週間後)