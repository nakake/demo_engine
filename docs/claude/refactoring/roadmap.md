# リファクタリング ロードマップ

## 概要

Demo Engine の段階的改善計画。現在のプロトタイプから本格的な 3D エンジンへの進化を3段階で実現します。

```
Current State → Phase 1 → Phase 2 → Phase 3
プロトタイプ   クリーンアップ  アーキテクチャ改善   本格3Dエンジン
```

## フェーズ一覧

| フェーズ | 期間 | リスク | 目標 | 成果物 |
|---------|------|-------|------|--------|
| **Phase 1** | 1-2日 | 🟢 低 | 技術的負債解消 | クリーンなコードベース |
| **Phase 2** | 1-2週間 | 🟡 中 | アーキテクチャ改善 | 拡張可能な設計 |
| **Phase 3** | 1-3ヶ月 | 🔴 高 | 本格3Dエンジン | プロダクションレディ |

## 詳細スケジュール

### Phase 1: 即座のリファクタリング (1-2日)

**目標**: 開発基盤の整備とコード品質向上

**Week 1**
- **Day 1**
  - [ ] 未使用import・変数の削除 (2時間)
  - [ ] Debug出力の制御システム実装 (3時間)
  - [ ] constants.rs作成とマジックナンバー移行 (2時間)
- **Day 2**  
  - [ ] 未使用エラー型の整理 (1時間)
  - [ ] 基本ドキュメント追加 (2時間)
  - [ ] テストディレクトリ構造作成 (2時間)
  - [ ] 基本メトリクス実装 (2時間)

**成功基準**: 
- ✅ cargo build で警告ゼロ
- ✅ 構造化されたログ出力
- ✅ テスト実行環境の整備

### Phase 2: 短期改善 (1-2週間)

**目標**: アーキテクチャの改善と機能拡張

**Week 1: アーキテクチャ分離**
- **Day 1-2**: GraphicsEngine 分割設計と実装
- **Day 3**: Renderer, SurfaceManager 実装
- **Day 4**: 設定システム基盤実装
- **Day 5**: 統合テストと検証

**Week 2: 機能拡張**
- **Day 1-2**: SceneManager リファクタリング
- **Day 3**: 入力バインディングシステム
- **Day 4**: Transform システム実装
- **Day 5**: マルチオブジェクト対応とテスト

**成功基準**:
- ✅ 責任分離されたアーキテクチャ
- ✅ 外部設定ファイル対応
- ✅ 複数オブジェクトレンダリング
- ✅ 設定可能な入力バインディング

### Phase 3: 長期改善 (1-3ヶ月)

**目標**: 本格的な3Dエンジンへの発展

**Month 1: 基盤アーキテクチャ**
- **Week 1**: ECS フレームワーク設計・実装
- **Week 2**: マルチスレッドレンダリング基盤
- **Week 3**: マテリアルシステム基盤
- **Week 4**: テクスチャローディング実装

**Month 2: レンダリング機能拡張**
- **Week 1**: PBR シェーダー実装
- **Week 2**: ライティングシステム (複数光源)
- **Week 3**: シャドウマッピング
- **Week 4**: フラスタムカリング実装

**Month 3: ツールと最適化**
- **Week 1**: アセットパイプライン
- **Week 2**: デバッグUI/エディター (egui)
- **Week 3**: パフォーマンス最適化 (LOD, インスタンシング)
- **Week 4**: 物理シミュレーション統合 (rapier)

**成功基準**:
- ✅ ECS アーキテクチャ
- ✅ PBR マテリアル対応
- ✅ リアルタイムエディター
- ✅ 高パフォーマンス最適化

## 優先度マトリクス

### 高優先度 (必須)
1. **Phase 1 全体** - 技術的負債の解消
2. **GraphicsEngine 分割** - アーキテクチャの基盤
3. **ECS 導入** - 拡張性の確保
4. **マテリアルシステム** - レンダリング品質向上

### 中優先度 (推奨)  
1. **設定システム** - ユーザビリティ向上
2. **複数光源サポート** - 視覚品質向上
3. **デバッグUI** - 開発効率向上
4. **フラスタムカリング** - パフォーマンス改善

### 低優先度 (オプション)
1. **物理シミュレーション** - 特定用途向け
2. **LOD システム** - 大規模シーン向け
3. **IBL** - 高品質レンダリング向け
4. **アセットエディター** - コンテンツ制作向け

## リスク評価と対策

### Phase 1 リスク (🟢 低)
- **リスク**: 既存機能の破壊
- **対策**: 小さい変更、段階的実装、テスト併用

### Phase 2 リスク (🟡 中)
- **リスク**: アーキテクチャ変更による不安定化
- **対策**: ブランチ分離、統合テスト、ロールバック計画

### Phase 3 リスク (🔴 高)
- **リスク**: 大規模変更による開発期間延長
- **対策**: MVP方式、段階的リリース、機能の優先度付け

## 成功メトリクス

### 技術メトリクス
- **コード品質**: 警告数、テストカバレッジ、Clippy 評価
- **パフォーマンス**: FPS、メモリ使用量、レンダリング時間
- **保守性**: 循環的複雑度、モジュール結合度

### 機能メトリクス  
- **Phase 1**: 警告0個、テスト実行可能、ドキュメント整備
- **Phase 2**: 複数シーン、設定外部化、マルチオブジェクト
- **Phase 3**: PBR対応、エディターUI、物理シミュレーション

## 依存関係グラフ

```
Phase 1 (基盤整備)
    ↓
Phase 2-1 (アーキテクチャ)
    ├── Phase 2-2 (設定システム)
    └── Phase 2-3 (機能拡張)
        ↓
Phase 3-1 (ECS)
    ├── Phase 3-2 (レンダリング拡張)
    └── Phase 3-3 (ツール・最適化)
```

## 中断・復帰戦略

各フェーズは独立して価値を提供するよう設計されています：

- **Phase 1のみ完了**: クリーンで保守しやすいプロトタイプ
- **Phase 2まで完了**: 小規模な3Dアプリケーション開発可能
- **Phase 3まで完了**: 商用レベルの3Dエンジン

## 次のステップ

1. **Phase 1 開始**: [phase_1_immediate.md](./phase_1_immediate.md) の実装チェックリストに従う
2. **進捗追跡**: 各フェーズの成功基準を満たしているかチェック
3. **定期レビュー**: 週次でロードマップの見直しと調整

---

**現在の状態**: Phase 0 完了 (基本実装)  
**次のアクション**: Phase 1 開始  
**推定完了時期**: Phase 1 (2日後), Phase 2 (2週間後), Phase 3 (3ヶ月後)