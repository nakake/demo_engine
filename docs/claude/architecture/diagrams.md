# アーキテクチャ図解

## 現在のアーキテクチャ (Phase 0)

### システム概要図
```
┌─────────────────────────────────────────────────────────────┐
│                      Demo Engine                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │     App     │  │    Input    │  │   Window    │          │
│  │ (Lifecycle) │←→│   (State)   │←→│(Abstraction)│          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │            GraphicsEngine (God Object)                 │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │  Rendering  │ │   Surface   │ │    Scene    │      │ │
│  │  │   Logic     │ │  Management │ │  Management │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ Resources   │  │    Scene    │  │   Camera    │          │
│  │  Manager    │←→│   (Demo)    │←→│  System     │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                     WGPU + Winit                           │
└─────────────────────────────────────────────────────────────┘
```

### モジュール依存関係
```
    app
     │
     ├─→ graphics ──┐
     ├─→ input      │
     ├─→ window     │
     └─→ scene ─────┼─→ resources
                    │
              core ←┘
```

**問題点**:
- GraphicsEngine が複数責任を持つ (God Object アンチパターン)
- 密結合な依存関係
- テスタビリティの低さ

## Phase 1 改善後: クリーンアップ

### 改善点
```
┌─────────────────────────────────────────────────────────────┐
│                      Demo Engine                           │
├─────────────────────────────────────────────────────────────┤
│         Constants, Config, Clean Error Handling            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │     App     │  │    Input    │  │   Window    │          │
│  │(Structured) │←→│(Configurable│←→│(Documented) │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│         │              ↑                                    │
│         │              │ Logging System                     │
│         ▼              ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │            GraphicsEngine (Still Monolithic)           │ │
│  │          But with Better Error Handling                │ │
│  └─────────────────────────────────────────────────────────┘ │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ Resources   │  │    Scene    │  │   Camera    │          │
│  │ (Tested)    │←→│ (Tested)    │←→│ (Tested)    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                Test Foundation + Metrics                   │
└─────────────────────────────────────────────────────────────┘
```

## Phase 2 改善後: アーキテクチャ改善

### 責任分離されたアーキテクチャ
```
┌─────────────────────────────────────────────────────────────┐
│                      Demo Engine                           │
├─────────────────────────────────────────────────────────────┤
│                    Configuration System                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │     App     │  │ InputSystem │  │   Window    │          │
│  │ (Coordinator│←→│(Bindable)   │←→│ (Managed)   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                GraphicsEngine                          │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │  Renderer   │ │   Surface   │ │   Command   │      │ │
│  │  │  (Core)     │ │  Manager    │ │   Buffer    │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ Resources   │  │Scene Manager│  │ Transform   │          │
│  │ (Enhanced)  │←→│(Multi-Scene)│←→│  System     │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│           Logging + Error Recovery + Profiling             │
└─────────────────────────────────────────────────────────────┘
```

### データフローの改善
```
Input Events → InputSystem → Actions → Scene → Transform → Renderer → GPU
     ↑                          ↓                    ↑          ↓
Config File ←── Settings ←── SceneManager ←── Resources ←── Materials
```

## Phase 3 最終形: ECS アーキテクチャ

### Entity Component System
```
┌─────────────────────────────────────────────────────────────┐
│                    Demo Engine (ECS)                       │
├─────────────────────────────────────────────────────────────┤
│                     Asset Pipeline                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │     App     │  │ InputSystem │  │   Window    │          │
│  │(Coordinator)│←→│ (Advanced)  │←→│ (Managed)   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                    ECS World                           │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │  Entities   │ │ Components  │ │   Systems   │      │ │
│  │  │             │ │             │ │             │      │ │
│  │  │ ┌─────────┐ │ │ Transform   │ │ RenderSys   │      │ │
│  │  │ │Entity 1 │ │ │ MeshRender  │ │ PhysicsSys  │      │ │
│  │  │ │Entity 2 │ │ │ RigidBody   │ │ LightingSys │      │ │
│  │  │ │Entity 3 │ │ │ Light       │ │ CullingSys  │      │ │
│  │  │ │   ...   │ │ │ Camera      │ │ AudioSys    │      │ │
│  │  │ └─────────┘ │ │ Material    │ │ AnimationSys│      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ Multi-Thread│  │ Asset Server│  │ Debug UI    │          │
│  │  Renderer   │←→│  (Hot Reload│←→│ (egui)      │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│         Physics (rapier) + Advanced Graphics (PBR)         │
└─────────────────────────────────────────────────────────────┘
```

### ECS システム間データフロー
```
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│  InputSystem   │───▶│ TransformSys   │───▶│  RenderSystem  │
└────────────────┘    └────────────────┘    └────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│  PhysicsSystem │◀───│  CullingSystem │───▶│ LightingSystem │
└────────────────┘    └────────────────┘    └────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
         └──────────────────────┼──────────────────────┘
                                ▼
                     ┌────────────────┐
                     │     World      │
                     │  (ECS Storage) │
                     └────────────────┘
```

## レンダリングパイプライン進化

### Phase 0: 基本パイプライン
```
Scene Objects → Vertex Buffer → Vertex Shader → Fragment Shader → Screen
```

### Phase 2: マルチオブジェクト
```
Multiple Objects → Transforms → Uniforms → Shaders → Screen
      ↓              ↓           ↓          ↓
   Resource      Matrix       Buffer    Pipeline
   Management    Calculation   Update    Binding
```

### Phase 3: 高度なパイプライン
```
                     ┌─ Shadow Mapping
ECS Query → Culling ─┤
    ↓         ↓      └─ Forward Rendering
Materials  Batching        ↓
    ↓         ↓      ┌─ PBR Lighting
Textures   Instances ┤
    ↓         ↓      └─ Post Processing
Uniforms   GPU Upload      ↓
    ↓         ↓           Screen
    └─────────┴─────────────┘
```

## メモリレイアウト比較

### Phase 0: モノリシック
```
┌──────────────────────────────────┐
│         GraphicsEngine           │
│  ┌─────────┬─────────┬─────────┐ │
│  │ Device  │  Queue  │ Surface │ │
│  ├─────────┼─────────┼─────────┤ │
│  │Resources│ Scenes  │ Camera  │ │
│  └─────────┴─────────┴─────────┘ │
└──────────────────────────────────┘
```

### Phase 3: ECS
```
┌──────────────────────────────────┐
│             World                │
│  ┌─────────────────────────────┐ │
│  │        Components           │ │
│  │ [Transform|Transform|...]   │ │
│  │ [Mesh     |Mesh     |...]   │ │
│  │ [Material |Material |...]   │ │
│  └─────────────────────────────┘ │
├──────────────────────────────────┤
│            Systems               │
│  ┌─────────┬─────────┬─────────┐ │
│  │ Render  │Physics  │Lighting │ │
│  └─────────┴─────────┴─────────┘ │
└──────────────────────────────────┘
```

## パフォーマンス特性の変化

### Phase 0
- **シングルスレッド**: メインスレッドですべて処理
- **オブジェクト数**: 1-10個程度
- **フレームレート**: 60 FPS (VSync制限)

### Phase 2
- **部分的並列化**: レンダリングコマンドの最適化
- **オブジェクト数**: 100個程度
- **フレームレート**: 60+ FPS

### Phase 3
- **マルチスレッド**: システム並列実行
- **オブジェクト数**: 1000+個 (カリング込み)
- **フレームレート**: 120+ FPS (可変リフレッシュレート対応)

---

これらの図解により、各フェーズでのアーキテクチャ進化が視覚的に理解できます。現在のシンプルな構造から、最終的には商用レベルの高度なアーキテクチャへと段階的に発展していきます。